<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Midnight Errands (POV Episode)</title>
  <style>
    :root{
      --bg:#0b0f14; --ui:#0f172a; --ui2:#111827;
      --line:rgba(255,255,255,.12); --ink:#e5e7eb; --muted:#94a3b8;
      --accent:#60a5fa; --warn:#fb7185; --ok:#34d399; --shadow:rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1100px 700px at 50% 0%, #1b2434, var(--bg));
      color:var(--ink); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:12px;}
    .wrap{width:min(1250px,100%); display:grid; grid-template-columns: 1.55fr .45fr; gap:12px;}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:14px; box-shadow: 0 14px 34px var(--shadow); overflow:hidden;}
    .topbar{display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px; border-bottom:1px solid var(--line); background: rgba(255,255,255,.03);}
    .topbar b{font-size:14px}
    .topbar small{display:block; color:var(--muted); font-size:12px}
    .hud{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{font-size:12px; color:var(--muted); padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background: rgba(255,255,255,.03); white-space:nowrap;}
    .pill strong{color:var(--ink)}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle;background:var(--ok);box-shadow:0 0 0 3px rgba(52,211,153,.15)}
    .pill.warn .dot{background:var(--warn);box-shadow:0 0 0 3px rgba(251,113,133,.15)}
    .game{display:grid; grid-template-rows: auto 1fr auto; height: 780px; max-height: 92vh;}
    canvas{width:100%; height:auto; display:block; background:#070b10; cursor:crosshair;}
    .dialogue{border-top:1px solid var(--line); background: rgba(17,24,39,.92);
      padding:12px; display:grid; gap:10px;}
    .speakerRow{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .speaker{font-weight:800; letter-spacing:.2px; font-size:13px}
    .meta{color:var(--muted); font-size:12px}
    .text{font-size:14px; line-height:1.45; min-height:44px;}
    .choices{display:flex; gap:8px; flex-wrap:wrap;}
    button{border:1px solid var(--line); background: rgba(255,255,255,.04); color:var(--ink);
      padding:9px 10px; border-radius:12px; cursor:pointer; transition: transform .06s ease, border-color .06s ease;
      font-weight:650; font-size:12px;}
    button:hover{transform: translateY(-1px); border-color: rgba(96,165,250,.45)}
    .primary{border-color: rgba(96,165,250,.45); background: rgba(96,165,250,.08)}
    .danger{border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.08)}
    .phone{display:flex; flex-direction:column; height: 780px; max-height: 92vh;}
    .msgs{padding:10px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:10px;}
    .msg{max-width:95%; padding:10px; border-radius:14px; border:1px solid var(--line);
      background: rgba(255,255,255,.03); font-size:12.5px; line-height:1.35;}
    .them{align-self:flex-start; border-top-left-radius:6px}
    .me{align-self:flex-end; border-top-right-radius:6px; background: rgba(96,165,250,.08); border-color: rgba(96,165,250,.22)}
    .msg small{display:block; margin-top:5px; color:var(--muted); font-size:11px}
    .phoneFooter{border-top:1px solid var(--line); padding:10px; display:flex; gap:8px; background: rgba(255,255,255,.02);}
    input{flex:1; padding:10px; border-radius:12px; border:1px solid var(--line);
      background: rgba(0,0,0,.18); color:var(--ink); outline:none; font-size:12.5px;}
    .hint{color:var(--muted); font-size:12px; padding:10px 12px; border-top:1px solid var(--line); background: rgba(255,255,255,.02);}
    kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:11px; padding:2px 6px;
      border-radius:6px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color: var(--ink);}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card game">
    <div class="topbar">
      <div>
        <b>Midnight Errands (Original POV Episode)</b>
        <small>Move: <kbd>WASD</kbd> • Look: mouse • Interact: <kbd>E</kbd> • Flashlight: <kbd>F</kbd> • Inventory: <kbd>I</kbd> • Esc: release mouse</small>
      </div>
      <div class="hud">
        <span class="pill" id="vibePill"><span class="dot"></span> Vibe: <strong id="vibe">Calm</strong></span>
        <span class="pill">Time: <strong id="clock">10:41 PM</strong></span>
        <span class="pill">Tasks: <strong id="tasks">3</strong></span>
        <span class="pill">Flashlight: <strong id="flashHud">ON</strong></span>
      </div>
    </div>

    <canvas id="c" width="960" height="540"></canvas>

    <div class="dialogue">
      <div class="speakerRow">
        <div class="speaker" id="speaker">Narrator</div>
        <div class="meta" id="meta">Click the game to capture the mouse</div>
      </div>
      <div class="text" id="dialogue">You’re house-sitting for a neighbor. Quick checklist. Then chill. It’s probably fine.</div>
      <div class="choices" id="choices"></div>
    </div>
  </div>

  <div class="card phone">
    <div class="topbar">
      <div>
        <b>Phone</b>
        <small>Neighbor • Friend • Unknown</small>
      </div>
      <small style="color:var(--muted);font-size:12px">Type “ok” and press Send</small>
    </div>
    <div class="msgs" id="msgs"></div>
    <div class="phoneFooter">
      <input id="input" placeholder="Reply… (help)"/>
      <button class="primary" id="send">Send</button>
    </div>
    <div class="hint">This is an original “spooky neighbor house” episode. Don’t open the door for strangers.</div>
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const canvas = $("c");
  const ctx = canvas.getContext("2d");
  const msgsEl = $("msgs");
  const input = $("input");
  const sendBtn = $("send");
  const speakerEl = $("speaker");
  const metaEl = $("meta");
  const dialogueEl = $("dialogue");
  const choicesEl = $("choices");
  const vibeEl = $("vibe");
  const vibePill = $("vibePill");
  const clockEl = $("clock");
  const tasksEl = $("tasks");
  const flashHud = $("flashHud");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const now = ()=>performance.now();

  // --------- Audio SFX (procedural) ----------
  let audioCtx=null, master=null;
  function initAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain();
    master.gain.value = 0.55;
    master.connect(audioCtx.destination);
  }
  function beep(freq, dur, type="sine", gain=0.2){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
    o.connect(g); g.connect(master);
    o.start(t0); o.stop(t0+dur+0.02);
  }
  function noiseBurst(dur=0.12, gain=0.18, freq=900){
    if(!audioCtx) return;
    const t0 = audioCtx.currentTime;
    const bufferSize = Math.floor(audioCtx.sampleRate * dur);
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    const g = audioCtx.createGain();
    g.gain.setValueAtTime(gain, t0);
    const f = audioCtx.createBiquadFilter();
    f.type = "bandpass";
    f.frequency.setValueAtTime(freq, t0);
    src.connect(f); f.connect(g); g.connect(master);
    src.start(t0);
  }
  const sfx = {
    text(){ initAudio(); beep(920,0.05,"square",0.08); beep(1240,0.05,"square",0.06); },
    step(){ initAudio(); noiseBurst(0.05, 0.08, 220); },
    door(){ initAudio(); beep(160,0.18,"sawtooth",0.07); noiseBurst(0.10,0.10,520); },
    rattle(){ initAudio(); noiseBurst(0.16,0.22,850); beep(130,0.14,"sawtooth",0.08); },
    sting(){ initAudio(); beep(240,0.10,"sawtooth",0.12); beep(180,0.18,"sawtooth",0.15); noiseBurst(0.14,0.16,1200); },
    pickup(){ initAudio(); beep(660,0.08,"triangle",0.08); beep(880,0.08,"triangle",0.06); },
    toggle(){ initAudio(); beep(520,0.05,"square",0.05); },
  };

  // --------- UI helpers ----------
  function addMsg(who, text){
    const div = document.createElement("div");
    div.className = "msg " + (who==="me" ? "me" : "them");
    div.innerHTML = `<div>${text.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}</div><small>${who==="me"?"You":who} • ${timeStr()}</small>`;
    msgsEl.appendChild(div);
    msgsEl.scrollTop = msgsEl.scrollHeight;
    if(who !== "me") sfx.text();
  }
  function setDialogue(speaker, text, buttons=[]){
    speakerEl.textContent = speaker;
    dialogueEl.textContent = text;
    choicesEl.innerHTML = "";
    for(const b of buttons){
      const btn = document.createElement("button");
      btn.textContent = b.label;
      btn.className = b.kind || "";
      btn.onclick = b.onClick;
      choicesEl.appendChild(btn);
    }
  }

  // --------- Time ----------
  const state = {
    minute: 0, dread: 0,
    started:false, finished:false,
    beat:0, doorKnock:false, unknownText:false, windowTap:false,
    called:false, lastStepSfx:0
  };
  function timeStr(){
    const start = 22*60 + 41; // 10:41 PM
    const t = start + state.minute;
    const h24 = Math.floor(t/60)%24;
    const m = t%60;
    const ampm = h24>=12 ? "PM" : "AM";
    let h = h24%12; if(h===0) h=12;
    return `${h}:${String(m).padStart(2,"0")} ${ampm}`;
  }

  // --------- Map (original house layout) ----------
  const MAP_W=22, MAP_H=14;
  const mapRows = [
    "1111111111111111111111",
    "1000000000000010000001",
    "1011110111111010111101",
    "1000010000000010100001",
    "1111011110111010111101",
    "1000010000100010000001",
    "1011010111101111101101",
    "1010010000001000100001",
    "1011110111111010101101",
    "1000000100000010000001",
    "1001000100100010011101",
    "1001000100100010000001",
    "1000000000000000000001",
    "1111111111111111111111",
  ];
  const map = mapRows.map(r=>r.split("").map(ch=>ch==="1"?1:0));
  const isWall = (x,y)=>{
    const mx=Math.floor(x), my=Math.floor(y);
    if(mx<0||my<0||mx>=MAP_W||my>=MAP_H) return true;
    return map[my][mx]===1;
  };

  // --------- Objects ----------
  const objects = [
    { id:"frontDoor", x: 18.5, y: 1.5, kind:"door", name:"Front Door", locked:false, open:0, opening:false },
    { id:"garage",    x: 1.5,  y: 12.5, kind:"door", name:"Garage Door", locked:false, open:0, opening:false },
    { id:"windows",   x: 16.5, y: 3.5, kind:"task", name:"Close Blinds", done:false },
    { id:"alarm",     x: 10.5, y: 2.5, kind:"task", name:"Turn On Alarm", done:false },
    { id:"kitchen",   x: 4.5,  y: 6.5, kind:"task", name:"Check Back Lock", done:false },
    { id:"flashbat",  x: 12.5, y: 12.5, kind:"item", name:"Extra Batteries", picked:false },
    { id:"sparekey",  x: 7.5,  y: 5.5, kind:"item", name:"Spare Key", picked:false },
  ];
  const inventory = new Set();
  const tasksLeft = ()=> objects.filter(o=>o.kind==="task" && !o.done).length;

  // --------- Player POV ----------
  const player = { x: 11.0, y: 11.2, a: -Math.PI/2, fov: Math.PI/3, moveSpeed: 2.6, bob:0, bobPhase:0 };
  let pointerLocked=false;
  canvas.addEventListener("click", ()=>{ if(state.finished) return; initAudio(); canvas.requestPointerLock?.(); });
  document.addEventListener("pointerlockchange", ()=>{
    pointerLocked = (document.pointerLockElement===canvas);
    metaEl.textContent = pointerLocked ? "Mouse captured • Esc releases" : "Click the game to capture the mouse";
  });
  document.addEventListener("mousemove",(e)=>{ if(pointerLocked && state.started && !state.finished) player.a += e.movementX*0.0022; });

  const keys=new Set();
  window.addEventListener("keydown",(e)=>{
    const k=e.key.toLowerCase();
    keys.add(k);
    if(k==="e") interact();
    if(k==="f") toggleFlash();
    if(k==="i") showInv();
  });
  window.addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

  // --------- Flashlight ----------
  const flash = { on:true, battery:1.0, drainPerMin:0.012, cone:0.42, range:7.0 };
  function toggleFlash(){
    if(!state.started || state.finished) return;
    flash.on = !flash.on;
    sfx.toggle();
    flashHud.textContent = flash.on ? "ON" : "OFF";
    setDialogue("Narrator", flash.on ? "Flashlight on." : "Flashlight off.", []);
  }

  // --------- Raycast ----------
  const RAYS=360;
  function castRay(ax){
    const sin=Math.sin(ax), cos=Math.cos(ax);
    let dist=0; const step=0.02;
    for(let i=0;i<3600;i++){
      dist+=step;
      const x=player.x+cos*dist, y=player.y+sin*dist;
      const mx=Math.floor(x), my=Math.floor(y);
      if(mx<0||my<0||mx>=MAP_W||my>=MAP_H) break;
      if(map[my][mx]===1){
        const fx=x-mx, fy=y-my;
        const side=(fx<0.02||fx>0.98)?1:(fy<0.02||fy>0.98)?2:0;
        return {hit:true, dist, side};
      }
    }
    return {hit:false, dist:999, side:0};
  }
  function flashlightAmount(rayA, dist){
    if(!flash.on || flash.battery<=0.02) return 0.22;
    const diff = Math.atan2(Math.sin(rayA-player.a), Math.cos(rayA-player.a));
    const inCone = Math.abs(diff) <= flash.cone;
    if(!inCone) return 0.25;
    const rangeFactor = clamp(1 - dist/flash.range, 0, 1);
    const centerFactor = clamp(1 - (Math.abs(diff)/flash.cone), 0, 1);
    return 0.25 + 0.9*(rangeFactor*centerFactor);
  }

  // --------- Draw ----------
  function draw(){
    const w=canvas.width, h=canvas.height;
    const horizonShift = player.bob * 14;

    ctx.fillStyle="#05070b"; ctx.fillRect(0,0,w,h/2+horizonShift);
    ctx.fillStyle="#060a12"; ctx.fillRect(0,h/2+horizonShift,w,h/2-horizonShift);

    // floor stripes
    for(let y=h/2+horizonShift; y<h; y+=6){
      const a=clamp((y-(h/2+horizonShift))/(h/2),0,1);
      ctx.fillStyle=`rgba(255,255,255,${0.018*(1-a)})`;
      ctx.fillRect(0,y,w,1);
    }

    const depth = new Array(RAYS).fill(999);
    for(let i=0;i<RAYS;i++){
      const rayA = player.a - player.fov/2 + (i/(RAYS-1))*player.fov;
      const r = castRay(rayA);
      if(!r.hit) continue;

      const corrected = r.dist * Math.cos(rayA-player.a);
      depth[i]=corrected;

      const wallH = clamp((h*0.92)/(corrected+0.0001), 0, h*1.3);
      const x = (i/RAYS)*w;
      const colW = (w/RAYS)+1;

      const shade = clamp(1 - corrected/8.4, 0.05, 1);
      const base = 28 + Math.floor(120*shade);
      const sideDark = (r.side ? 0.78 : 1.0);
      const wobble = Math.floor(10*Math.sin((i/18) + (corrected*0.9)));

      let rr=Math.floor((base+wobble)*sideDark);
      let gg=Math.floor((base+10+wobble)*sideDark);
      let bb=Math.floor((base+25+wobble)*sideDark);

      const light = flashlightAmount(rayA, corrected);
      rr=Math.floor(rr*(0.55+0.45*light));
      gg=Math.floor(gg*(0.55+0.45*light));
      bb=Math.floor(bb*(0.55+0.45*light));

      ctx.fillStyle=`rgb(${rr},${gg},${bb})`;
      ctx.fillRect(x,(h-wallH)/2+horizonShift,colW,wallH);
    }

    drawObjects(depth, horizonShift);
    drawOverlay(horizonShift);

    // crosshair
    ctx.strokeStyle="rgba(255,255,255,.55)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(w/2-8,h/2+horizonShift); ctx.lineTo(w/2+8,h/2+horizonShift);
    ctx.moveTo(w/2,h/2-8+horizonShift); ctx.lineTo(w/2,h/2+8+horizonShift);
    ctx.stroke();

    // prompt
    const t=getTarget();
    if(t){
      ctx.fillStyle="rgba(0,0,0,.45)";
      ctx.fillRect(12,h-44,w-24,32);
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.font="14px system-ui";
      ctx.fillText(`Press E: ${prompt(t)}`, 22, h-22);
    }
  }

  function drawOverlay(hShift){
    const w=canvas.width, h=canvas.height;
    const vg=ctx.createRadialGradient(w/2,h/2+hShift,h*0.15, w/2,h/2+hShift,h*0.75);
    vg.addColorStop(0,"rgba(0,0,0,0)");
    vg.addColorStop(1, flash.on ? "rgba(0,0,0,0.55)" : "rgba(0,0,0,0.72)");
    ctx.fillStyle=vg; ctx.fillRect(0,0,w,h);

    if(flash.on && flash.battery>0.02){
      ctx.save();
      ctx.translate(w/2,h/2+hShift);
      ctx.globalCompositeOperation="lighter";
      const g=ctx.createRadialGradient(0,0,10, 0,0, Math.min(w,h)*0.55);
      const strength=0.16+0.18*flash.battery;
      g.addColorStop(0,`rgba(120,170,255,${strength})`);
      g.addColorStop(1,"rgba(120,170,255,0)");
      ctx.fillStyle=g;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,Math.min(w,h)*0.62,-flash.cone,flash.cone);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
      ctx.globalCompositeOperation="source-over";
    }
    if(flash.battery<0.22){
      ctx.fillStyle=`rgba(251,113,133,${0.07*(1-(flash.battery/0.22))})`;
      ctx.fillRect(0,0,w,h);
    }
  }

  function drawObjects(depth,hShift){
    const w=canvas.width, h=canvas.height;
    const vis=[];
    for(const o of objects){
      if(o.kind==="item" && o.picked) continue;
      const dx=o.x-player.x, dy=o.y-player.y;
      const dRaw=Math.hypot(dx,dy);
      if(dRaw>7.4) continue;
      const ang=Math.atan2(dy,dx);
      const rel=Math.atan2(Math.sin(ang-player.a),Math.cos(ang-player.a));
      if(Math.abs(rel)>player.fov/2+0.25) continue;
      const idx=Math.floor(((rel+player.fov/2)/player.fov)*(RAYS-1));
      const corrected=dRaw*Math.cos(rel);
      if(idx>=0 && idx<RAYS && depth[idx] < corrected-0.06) continue;
      vis.push({o,rel,dist:corrected});
    }
    vis.sort((a,b)=>b.dist-a.dist);

    for(const v of vis){
      const {o,rel,dist}=v;
      const size=clamp((h*0.65)/(dist+0.0001),12,h*0.62);
      const xCenter=(0.5+(rel/player.fov))*w;
      const x=xCenter-size*0.18;
      const y=(h-size)/2+hShift;

      let widthMul=0.36, heightMul=1.0;
      let color="rgba(170,180,220,.85)";
      if(o.kind==="task") color=o.done?"rgba(52,211,153,.85)":"rgba(180,180,220,.85)";
      if(o.kind==="item") color="rgba(96,165,250,.85)";
      if(o.kind==="door") color=o.locked?"rgba(52,211,153,.85)":"rgba(251,113,133,.85)";

      if(o.kind==="door"){
        const open=o.open;
        widthMul=clamp(0.36*(1-open)+0.10*open,0.10,0.36);
      }

      ctx.fillStyle="rgba(0,0,0,.25)";
      ctx.fillRect(x+3,y+3,size*widthMul,size*heightMul);

      const light=flashlightAmount(player.a+rel,dist);
      const a=0.55+0.35*(0.5+0.5*light);
      ctx.fillStyle=color.replace(".85", String(a));
      ctx.fillRect(x,y,size*widthMul,size*heightMul);

      ctx.fillStyle="rgba(0,0,0,.28)";
      ctx.fillRect(x,y,size*widthMul,18);
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.font="12px system-ui";
      const tag=(o.kind==="door")?(o.locked?"LOCKED":"UNLOCKED"):(o.kind==="item"?"ITEM":"TASK");
      ctx.fillText(tag,x+6,y+13);
    }
  }

  // --------- Interaction ----------
  function getTarget(){
    let best=null;
    for(const o of objects){
      if(o.kind==="item" && o.picked) continue;
      const dx=o.x-player.x, dy=o.y-player.y;
      const dist=Math.hypot(dx,dy);
      if(dist>2.2) continue;
      const ang=Math.atan2(dy,dx);
      const diff=Math.atan2(Math.sin(ang-player.a),Math.cos(ang-player.a));
      if(Math.abs(diff)>0.20) continue;
      const r=castRay(ang);
      if(r.hit && r.dist < dist-0.06) continue;
      if(!best || dist<best.dist) best={o,dist};
    }
    return best?best.o:null;
  }
  function prompt(o){
    if(o.kind==="door"){
      if(o.opening) return `${o.name} (moving...)`;
      if(o.open>0.65) return `${o.name} (close)`;
      return o.locked ? `${o.name} (unlock/lock check)` : `${o.name} (open / lock)`;
    }
    if(o.kind==="task") return o.done ? `${o.name} (done)` : `${o.name} (do it)`;
    if(o.kind==="item") return `Pick up: ${o.name}`;
    return o.name;
  }

  function interact(){
    if(!state.started || state.finished) return;
    const t=getTarget(); if(!t) return;

    if(t.kind==="item"){
      t.picked=true; inventory.add(t.id); sfx.pickup();
      if(t.id==="flashbat"){ flash.battery=clamp(flash.battery+0.4,0,1); }
      setDialogue("You", `Picked up: ${t.name}.`, []);
      updateHUD(); return;
    }

    if(t.kind==="task"){
      if(t.done){ setDialogue("Narrator","Already done.",[]); return; }
      t.done=true;
      if(t.id==="alarm"){ state.dread=Math.max(0,state.dread-8); setDialogue("You","Alarm armed. Good.",[]); }
      if(t.id==="windows"){ state.dread=Math.max(0,state.dread-4); setDialogue("You","Blinds closed. I don’t like windows at night.",[]); }
      if(t.id==="kitchen"){ state.dread+=6; setDialogue("You","Back lock… sticky. Like it was pushed recently.",[]); }
      updateHUD(); checkProgress(); return;
    }

    if(t.kind==="door"){
      if(!t.locked && t.open<0.1){
        t.locked=true; sfx.door();
        setDialogue("Narrator", `${t.name} locked.`, []);
        updateHUD(); checkProgress(); return;
      }
      t.opening=true; sfx.door();
      const goingOpen=(t.open<0.5);
      t._targetOpen=goingOpen?1:0;
      setDialogue("Narrator", goingOpen?"Door opens…":"Door closes…", []);
      // bad choice: opening door after knock
      if(state.doorKnock && t.id==="frontDoor" && goingOpen){
        state.dread+=18; sfx.sting();
        setDialogue("Narrator","Bad idea.",[]);
      }
      updateHUD(); checkProgress(); return;
    }
  }

  function showInv(){
    if(!state.started || state.finished) return;
    const items=[...inventory].map(id=>objects.find(o=>o.id===id)?.name||id);
    setDialogue("Inventory", items.length?items.join(", "):"(empty)", [{label:"Close",kind:"primary",onClick:()=>setDialogue("Narrator","…",[])}]);
  }

  // --------- Movement ----------
  function move(dt){
    let f=0,s=0;
    if(keys.has("w")) f+=1;
    if(keys.has("s")) f-=1;
    if(keys.has("a")) s-=1;
    if(keys.has("d")) s+=1;

    const moving = Math.abs(f)+Math.abs(s)>0.1;
    const speed = player.moveSpeed*dt*(keys.has("shift")?1.25:1.0);
    const cos=Math.cos(player.a), sin=Math.sin(player.a);

    let nx=player.x+(cos*f - sin*s)*speed;
    let ny=player.y+(sin*f + cos*s)*speed;

    const pad=0.18;
    if(!isWall(nx,player.y) && !isWall(nx+Math.sign(nx-player.x)*pad,player.y)) player.x=nx;
    if(!isWall(player.x,ny) && !isWall(player.x,ny+Math.sign(ny-player.y)*pad,player.y)) player.y=ny;

    if(moving){
      player.bobPhase += dt*9.5;
      player.bob = Math.sin(player.bobPhase)*0.35;
      if(now()-state.lastStepSfx>260){ sfx.step(); state.lastStepSfx=now(); }
    } else {
      player.bob *= 0.90;
      if(Math.abs(player.bob)<0.01) player.bob=0;
    }
  }

  function updateDoors(dt){
    for(const o of objects){
      if(o.kind!=="door" || !o.opening) continue;
      const target=o._targetOpen ?? 0;
      o.open += (target-o.open)*clamp(1.6*dt,0,1);
      if(Math.abs(o.open-target)<0.02){ o.open=target; o.opening=false; }
    }
  }

  // --------- Story beats ----------
  function storyTick(mins){
    for(let i=0;i<mins;i++){
      state.minute++;
      flash.battery = clamp(flash.battery - flash.drainPerMin, 0, 1);
      if(flash.battery<=0.02){ flash.on=false; flashHud.textContent="OFF"; }

      const m=state.minute;

      if(m===1) addMsg("Neighbor","Thanks again. Checklist: blinds, alarm, back lock. Don’t open the door.");
      if(m===3) addMsg("Friend","I’d be too scared to house-sit. lol. Lock up.");

      if(m===6 && !state.windowTap){
        state.windowTap=true; state.dread+=10; sfx.rattle();
        setDialogue("Narrator","Tap… tap… on a window. Then nothing.",[
          {label:"Text Friend",kind:"primary",onClick:()=>{
            addMsg("me","I heard tapping on a window.");
            addMsg("Friend","Nope. Call someone if it happens again.");
            setDialogue("You","Okay…",[]);
          }},
          {label:"Ignore",onClick:()=>setDialogue("You","Probably a tree branch. Probably.",[])}
        ]);
      }

      if(m===9 && !state.unknownText){
        state.unknownText=true; state.dread+=16; sfx.sting();
        addMsg("Unknown","dont turn on the alarm");
        setDialogue("Narrator","Unknown number. It knows your checklist.",[
          {label:"Call Neighbor",kind:"danger",onClick:callNeighbor},
          {label:"Reply: who is this?",kind:"danger",onClick:()=>{
            addMsg("me","Who is this?");
            addMsg("Unknown","you already looked outside once.");
            sfx.sting(); state.dread+=10;
            setDialogue("Narrator","Your throat goes dry.",[]);
          }},
          {label:"Don’t reply",kind:"primary",onClick:()=>setDialogue("You","Nope. Not replying.",[])}
        ]);
      }

      if(m===12 && !state.doorKnock){
        state.doorKnock=true; state.dread+=18; sfx.rattle(); sfx.sting();
        setDialogue("Narrator","KNOCK. KNOCK. KNOCK. Three slow knocks at the front door.",[
          {label:"Call Neighbor",kind:"danger",onClick:callNeighbor},
          {label:"Stay still",kind:"primary",onClick:()=>setDialogue("You","I’m not moving.",[])}
        ]);
      }

      if(m>=22 && !state.finished){
        const done = tasksLeft()===0;
        const frontLocked = objects.find(o=>o.id==="frontDoor")?.locked;
        const garageLocked = objects.find(o=>o.id==="garage")?.locked;

        if(done && frontLocked && garageLocked && state.called){
          end("SAFE", "You did everything right. The neighbor arrives with someone else. Nobody opens the door. Smart wins.");
        } else {
          end("SURVIVED", "The night drags. Nothing breaks in… but you swear you heard footsteps outside. You’re never house-sitting again.");
        }
      }

      state.dread = clamp(state.dread,0,100);
    }
  }

  function callNeighbor(){
    if(state.called) return;
    state.called=true;
    addMsg("me","Calling you now. Someone knocked and I got a weird text.");
    addMsg("Neighbor","Stay inside. Lock BOTH doors. I’m on my way and I’m calling my neighbor too.");
    state.dread=Math.max(0,state.dread-10);
    setDialogue("Neighbor","Do NOT open the door. I’m coming.",[]);
  }

  function checkProgress(){
    // opening door after knock = bad ending
    const front = objects.find(o=>o.id==="frontDoor");
    if(state.doorKnock && front && front.open>0.65 && !state.finished){
      end("BAD CHOICE", "You opened the door after the knock. Cold air rushes in… and you realize you just made a mistake.");
      return;
    }
    if(state.dread>=100 && !state.finished){
      end("PANIC", "You hit full panic. Every sound becomes a threat. You freeze.");
      return;
    }
    // encourage call if you did the right prep
    const done = tasksLeft()===0;
    const frontLocked = objects.find(o=>o.id==="frontDoor")?.locked;
    const garageLocked = objects.find(o=>o.id==="garage")?.locked;
    if(done && frontLocked && garageLocked && state.doorKnock && !state.called){
      setDialogue("Narrator","You locked up and did the checklist. Now call the neighbor.",[
        {label:"Call Neighbor",kind:"danger",onClick:callNeighbor},
        {label:"Wait",kind:"primary",onClick:()=>setDialogue("You","I’m waiting.",[])}
      ]);
    }
  }

  function updateHUD(){
    clockEl.textContent=timeStr();
    tasksEl.textContent=tasksLeft();
    let vibe="Calm", warn=false;
    if(state.dread>=70){ vibe="PANIC"; warn=true; }
    else if(state.dread>=45){ vibe="On Edge"; warn=true; }
    else if(state.dread>=25){ vibe="Uneasy"; }
    vibeEl.textContent=vibe;
    warn ? vibePill.classList.add("warn") : vibePill.classList.remove("warn");
  }

  function end(title,text){
    state.finished=true;
    document.exitPointerLock?.();
    setDialogue("Ending: "+title, text, [
      {label:"Restart",kind:"primary",onClick:reset},
      {label:"Release mouse",onClick:()=>document.exitPointerLock?.()}
    ]);
  }

  // --------- Loop ----------
  let last=performance.now(), acc=0;
  function update(dt){
    if(!state.started || state.finished) return;
    move(dt); updateDoors(dt);
    acc += dt;
    if(acc>=2.8){
      const mins=Math.floor(acc/2.8);
      acc -= mins*2.8;
      storyTick(mins);
      updateHUD();
      checkProgress();
    }
    if(flash.battery<0.15 && flash.on) state.dread += 0.03;
  }
  function loop(t){
    const dt=Math.min(0.033,(t-last)/1000);
    last=t;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  // --------- Phone send ----------
  function handleSend(){
    const t=input.value.trim(); if(!t) return;
    initAudio();
    addMsg("me", t);
    input.value="";
    const lower=t.toLowerCase();
    if(lower==="help"){ addMsg("Neighbor","Type: ok / calling / where are you"); return; }
    if(lower==="ok"){ addMsg("Neighbor","Good. Lock both doors. Don’t open the door."); state.dread=Math.max(0,state.dread-2); updateHUD(); return; }
    if(lower.includes("calling")){ callNeighbor(); return; }
    if(lower.includes("where")){ addMsg("Neighbor","About 12 minutes away."); return; }
    addMsg("Neighbor","Okay. Keep me posted.");
  }
  sendBtn.addEventListener("click", handleSend);
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") handleSend(); });

  // --------- Start/reset ----------
  function start(){
    state.started=true;
    setDialogue("Narrator","Goal: Close blinds, turn on alarm, check back lock. Lock BOTH doors. (Click screen for mouse look.)",[
      {label:"Let’s go",kind:"primary",onClick:()=>setDialogue("Narrator","Do the checklist. Keep your phone loud.",[])},
      {label:"Controls",onClick:()=>setDialogue("Controls","WASD move, mouse look (click game), E interact, F flashlight, I inventory, Esc release mouse.",[{label:"Back",kind:"primary",onClick:()=>setDialogue("Narrator","Do the checklist. Keep your phone loud.",[])}])}
    ]);
  }
  function reset(){
    state.minute=0; state.dread=0; state.started=false; state.finished=false;
    state.doorKnock=false; state.unknownText=false; state.windowTap=false; state.called=false;
    acc=0;
    player.x=11.0; player.y=11.2; player.a=-Math.PI/2; player.bob=0; player.bobPhase=0;
    flash.on=true; flash.battery=1.0; flashHud.textContent="ON";
    inventory.clear();
    for(const o of objects){
      if(o.kind==="door"){ o.locked=false; o.open=0; o.opening=false; o._targetOpen=0; }
      if(o.kind==="task"){ o.done=false; }
      if(o.kind==="item"){ o.picked=false; }
    }
    msgsEl.innerHTML="";
    addMsg("Neighbor","Thanks for watching the place. Quick checklist then relax.");
    addMsg("Friend","If anything feels off, call somebody.");
    setDialogue("Narrator","Click the game to capture the mouse. Then hit Start.",[
      {label:"Start",kind:"primary",onClick:start}
    ]);
    updateHUD();
  }

  // boot
  reset();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
