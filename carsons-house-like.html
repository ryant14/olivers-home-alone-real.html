<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carson's House — POV 3D (2 Floors)</title>
<style>
  :root{
    --bg:#0b0f14; --ui:#0f172a; --ui2:#111827;
    --line:rgba(255,255,255,.12); --ink:#e5e7eb; --muted:#94a3b8;
    --accent:#60a5fa; --warn:#fb7185; --ok:#34d399; --shadow:rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1100px 700px at 50% 0%, #1b2434, var(--bg));
    color:var(--ink); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:12px;}
  .wrap{width:min(1250px,100%); display:grid; grid-template-columns: 1.55fr .45fr; gap:12px;}
  .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid var(--line); border-radius:14px; box-shadow: 0 14px 34px var(--shadow); overflow:hidden;}
  .topbar{display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px 12px; border-bottom:1px solid var(--line); background: rgba(255,255,255,.03);}
  .topbar b{font-size:14px}
  .topbar small{display:block; color:var(--muted); font-size:12px}
  .hud{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
  .pill{font-size:12px; color:var(--muted); padding:6px 10px; border-radius:999px;
    border:1px solid var(--line); background: rgba(255,255,255,.03); white-space:nowrap;}
  .pill strong{color:var(--ink)}
  .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;vertical-align:middle;background:var(--ok);box-shadow:0 0 0 3px rgba(52,211,153,.15)}
  .pill.warn .dot{background:var(--warn);box-shadow:0 0 0 3px rgba(251,113,133,.15)}
  .game{display:grid; grid-template-rows: auto 1fr auto; height: 780px; max-height: 92vh;}
  canvas{width:100%; height:auto; display:block; background:#070b10; cursor:crosshair;}
  .dialogue{border-top:1px solid var(--line); background: rgba(17,24,39,.92);
    padding:12px; display:grid; gap:10px;}
  .speakerRow{display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .speaker{font-weight:800; letter-spacing:.2px; font-size:13px}
  .meta{color:var(--muted); font-size:12px}
  .text{font-size:14px; line-height:1.45; min-height:44px;}
  .choices{display:flex; gap:8px; flex-wrap:wrap;}
  button{border:1px solid var(--line); background: rgba(255,255,255,.04); color:var(--ink);
    padding:9px 10px; border-radius:12px; cursor:pointer; transition: transform .06s ease, border-color .06s ease;
    font-weight:650; font-size:12px;}
  button:hover{transform: translateY(-1px); border-color: rgba(96,165,250,.45)}
  .primary{border-color: rgba(96,165,250,.45); background: rgba(96,165,250,.08)}
  .danger{border-color: rgba(251,113,133,.45); background: rgba(251,113,133,.08)}
  .phone{display:flex; flex-direction:column; height: 780px; max-height: 92vh;}
  .msgs{padding:10px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:10px;}
  .msg{max-width:95%; padding:10px; border-radius:14px; border:1px solid var(--line);
    background: rgba(255,255,255,.03); font-size:12.5px; line-height:1.35;}
  .them{align-self:flex-start; border-top-left-radius:6px}
  .me{align-self:flex-end; border-top-right-radius:6px; background: rgba(96,165,250,.08); border-color: rgba(96,165,250,.22)}
  .msg small{display:block; margin-top:5px; color:var(--muted); font-size:11px}
  .phoneFooter{border-top:1px solid var(--line); padding:10px; display:flex; gap:8px; background: rgba(255,255,255,.02);}
  input{flex:1; padding:10px; border-radius:12px; border:1px solid var(--line);
    background: rgba(0,0,0,.18); color:var(--ink); outline:none; font-size:12.5px;}
  .hint{color:var(--muted); font-size:12px; padding:10px 12px; border-top:1px solid var(--line); background: rgba(255,255,255,.02);}
  kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:11px; padding:2px 6px;
    border-radius:6px; border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color: var(--ink);}
</style>
</head>
<body>
<div class="wrap">
  <div class="card game">
    <div class="topbar">
      <div>
        <b>Carson’s House — POV 3D (2 Floors)</b>
        <small>Move: <kbd>WASD</kbd> • Look: mouse • Interact: <kbd>E</kbd> • Flashlight: <kbd>F</kbd> • Sprint: <kbd>Shift</kbd> • Esc: release mouse</small>
      </div>
      <div class="hud">
        <span class="pill" id="vibePill"><span class="dot"></span> Vibe: <strong id="vibe">Calm</strong></span>
        <span class="pill">Time: <strong id="clock">10:02 PM</strong></span>
        <span class="pill">Floor: <strong id="floorHud">1</strong></span>
        <span class="pill">Tasks: <strong id="tasks">4</strong></span>
        <span class="pill">Flash: <strong id="flashHud">ON</strong></span>
      </div>
    </div>

    <canvas id="c" width="960" height="540"></canvas>

    <div class="dialogue">
      <div class="speakerRow">
        <div class="speaker" id="speaker">Narrator</div>
        <div class="meta" id="meta">Click the game to capture the mouse</div>
      </div>
      <div class="text" id="dialogue">You’re watching Carson’s house while everyone’s out. Simple list. In and out. Don’t get weird about it.</div>
      <div class="choices" id="choices"></div>
    </div>
  </div>

  <div class="card phone">
    <div class="topbar">
      <div>
        <b>Phone</b>
        <small>Carson’s Mom • Friend • Unknown</small>
      </div>
      <small style="color:var(--muted);font-size:12px">Type “ok” and press Send</small>
    </div>
    <div class="msgs" id="msgs"></div>
    <div class="phoneFooter">
      <input id="input" placeholder="Reply… (help)"/>
      <button class="primary" id="send">Send</button>
    </div>
    <div class="hint">Tip: You can “Call” later if things get bad (button appears).</div>
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const canvas = $("c");
  const ctx = canvas.getContext("2d");

  const msgsEl = $("msgs");
  const input = $("input");
  const sendBtn = $("send");
  const speakerEl = $("speaker");
  const metaEl = $("meta");
  const dialogueEl = $("dialogue");
  const choicesEl = $("choices");
  const vibeEl = $("vibe");
  const vibePill = $("vibePill");
  const clockEl = $("clock");
  const tasksEl = $("tasks");
  const floorHud = $("floorHud");
  const flashHud = $("flashHud");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const now = ()=>performance.now();

  // ----------------- Audio (better) -----------------
  let audioCtx=null, master=null, ambGain=null, humOsc=null, noiseSrc=null, noiseFilter=null;
  function initAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain(); master.gain.value=0.80; master.connect(audioCtx.destination);

    ambGain = audioCtx.createGain(); ambGain.gain.value=0.0; ambGain.connect(master);

    humOsc = audioCtx.createOscillator(); humOsc.type="sine"; humOsc.frequency.value=52;
    const humG = audioCtx.createGain(); humG.gain.value=0.14;
    humOsc.connect(humG); humG.connect(ambGain); humOsc.start();

    const sr=audioCtx.sampleRate, len=sr*2;
    const buf=audioCtx.createBuffer(1,len,sr);
    const d=buf.getChannelData(0);
    for(let i=0;i<len;i++){
      const k=i/len;
      const wind = 0.55 + 0.45*Math.sin(k*Math.PI*4);
      d[i]=(Math.random()*2-1)*wind;
    }
    noiseSrc = audioCtx.createBufferSource(); noiseSrc.buffer=buf; noiseSrc.loop=true;
    noiseFilter = audioCtx.createBiquadFilter(); noiseFilter.type="lowpass"; noiseFilter.frequency.value=950;
    const nG = audioCtx.createGain(); nG.gain.value=0.10;
    noiseSrc.connect(noiseFilter); noiseFilter.connect(nG); nG.connect(ambGain);
    noiseSrc.start();
  }
  function ramp(g,to,t=0.35){
    if(!audioCtx) return;
    const tt=audioCtx.currentTime;
    g.gain.cancelScheduledValues(tt);
    g.gain.setValueAtTime(g.gain.value, tt);
    g.gain.linearRampToValueAtTime(to, tt+t);
  }
  function tone(freq,dur,type="sine",gain=0.12){
    if(!audioCtx) return;
    const t0=audioCtx.currentTime;
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type=type; o.frequency.setValueAtTime(freq,t0);
    g.gain.setValueAtTime(0.0001,t0);
    g.gain.exponentialRampToValueAtTime(gain,t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    o.connect(g); g.connect(master);
    o.start(t0); o.stop(t0+dur+0.02);
  }
  function noise(dur=0.12,gain=0.12,hp=350,lp=1800){
    if(!audioCtx) return;
    const t0=audioCtx.currentTime;
    const n=Math.floor(audioCtx.sampleRate*dur);
    const b=audioCtx.createBuffer(1,n,audioCtx.sampleRate);
    const dd=b.getChannelData(0);
    for(let i=0;i<n;i++){ const k=i/n; dd[i]=(Math.random()*2-1)*(1-k); }
    const s=audioCtx.createBufferSource(); s.buffer=b;
    const g=audioCtx.createGain(); g.gain.value=gain;
    const hpf=audioCtx.createBiquadFilter(); hpf.type="highpass"; hpf.frequency.value=hp;
    const lpf=audioCtx.createBiquadFilter(); lpf.type="lowpass"; lpf.frequency.value=lp;
    s.connect(hpf); hpf.connect(lpf); lpf.connect(g); g.connect(master);
    s.start(t0);
  }
  const sfx={
    text(){initAudio(); tone(980,0.04,"square",0.08); tone(1320,0.05,"square",0.06);},
    step(){initAudio(); noise(0.045,0.085,160,520); tone(120+Math.random()*35,0.05,"triangle",0.03);},
    door(){initAudio(); tone(210,0.12,"sawtooth",0.09); noise(0.16,0.12,250,1000);},
    pickup(){initAudio(); tone(720,0.08,"triangle",0.09); tone(980,0.08,"triangle",0.06);},
    toggle(){initAudio(); tone(520,0.05,"square",0.05);},
    sting(){initAudio(); tone(260,0.09,"sawtooth",0.16); noise(0.18,0.20,650,2600); tone(58,0.35,"sine",0.07);},
    thump(){initAudio(); noise(0.11,0.22,80,420); tone(72,0.10,"sine",0.09);},
    rattle(){initAudio(); noise(0.22,0.22,500,2400); tone(140,0.12,"sawtooth",0.06);}
  };

  // ----------------- UI helpers -----------------
  function escapeHTML(s){return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");}
  function addMsg(who,text){
    const div=document.createElement("div");
    div.className="msg "+(who==="me"?"me":"them");
    div.innerHTML=`<div>${escapeHTML(text)}</div><small>${who==="me"?"You":who} • ${timeStr()}</small>`;
    msgsEl.appendChild(div); msgsEl.scrollTop=msgsEl.scrollHeight;
    if(who!=="me") sfx.text();
  }
  function setDialogue(speaker,text,buttons=[]){
    speakerEl.textContent=speaker;
    dialogueEl.textContent=text;
    choicesEl.innerHTML="";
    for(const b of buttons){
      const btn=document.createElement("button");
      btn.textContent=b.label;
      btn.className=b.kind||"";
      btn.onclick=b.onClick;
      choicesEl.appendChild(btn);
    }
  }

  // ----------------- Time / story state -----------------
  const state={
    started:false, finished:false,
    minute:0, dread:0,
    floor:0, // 0=downstairs, 1=upstairs
    lastStepSfx:0,
    beatFlags:{unknown:false, window:false, upstairsNoise:false, knock:false, silhouette:false}
  };

  function timeStr(){
    const start=22*60+2; // 10:02 PM
    const t=start+state.minute;
    const h24=Math.floor(t/60)%24, m=t%60;
    const ampm=h24>=12?"PM":"AM";
    let h=h24%12; if(h===0) h=12;
    return `${h}:${String(m).padStart(2,"0")} ${ampm}`;
  }

  // ----------------- Two floors maps -----------------
  // 1 = wall, 0 = empty
  const MAPS = [
    [
      "1111111111111111111111",
      "1000000000000010000001",
      "1011110111111010111101",
      "1000010000000010100001",
      "1111011110111010111101",
      "1000010000100010000001",
      "1011010111101111101101",
      "1010010000001000100001",
      "1011110111111010101101",
      "1000000100000010000001",
      "1001000100100010011101",
      "1001000100100010000001",
      "1000000000000000000001",
      "1111111111111111111111",
    ],
    [
      "1111111111111111111111",
      "1000000000000000000001",
      "1011110111110111111101",
      "1000010000010000000001",
      "1011011111011110111101",
      "1000000000010000100001",
      "1011110111110111101101",
      "1000010000000000100001",
      "1011011110111110111101",
      "1000000000100000000001",
      "1011110111101111111101",
      "1000000000000000000001",
      "1000000010000000000001",
      "1111111111111111111111",
    ]
  ].map(grid => grid.map(r=>r.split("").map(c=>c==="1"?1:0)));

  const MAP_W=22, MAP_H=14;
  function map(){ return MAPS[state.floor]; }
  function isWall(x,y){
    const mx=Math.floor(x), my=Math.floor(y);
    if(mx<0||my<0||mx>=MAP_W||my>=MAP_H) return true;
    return map()[my][mx]===1;
  }

  // ----------------- Objects: doors, tasks, stairs, furniture, windows -----------------
  // "prop" objects are billboard sprites (furniture)
  const objs=[];
  function addObj(o){objs.push(o);}

  // stairs: interact to swap floors
  addObj({id:"stairsUp", kind:"stairs", name:"Stairs (Up)", floorFrom:0, floorTo:1, x:9.5,y:9.5});
  addObj({id:"stairsDown", kind:"stairs", name:"Stairs (Down)", floorFrom:1, floorTo:0, x:9.5,y:12.0});

  // doors (floor 1)
  addObj({id:"frontDoor", floor:0, x:18.5,y:1.5, kind:"door", name:"Front Door", locked:false, open:0, opening:false});
  addObj({id:"backDoor",  floor:0, x:1.5, y:12.5,kind:"door", name:"Back Door", locked:false, open:0, opening:false});

  // tasks (original, but new + upstairs)
  addObj({id:"lights", floor:0, x:10.5,y:2.5, kind:"task", name:"Turn Off Kitchen Light", done:false});
  addObj({id:"tv",     floor:0, x:15.5,y:9.5, kind:"task", name:"Make Sure TV Is Off", done:false});
  addObj({id:"trash",  floor:0, x:6.5, y:10.5,kind:"task", name:"Take Out Trash (to back door)", done:false});
  addObj({id:"checkUp",floor:1, x:14.5,y:3.5, kind:"task", name:"Check Upstairs Hallway Window", done:false});

  // items
  addObj({id:"batteries", floor:0, x:12.5,y:12.5, kind:"item", name:"Extra Batteries", picked:false});
  addObj({id:"keys",      floor:0, x:4.5, y:4.5,  kind:"item", name:"Spare House Key", picked:false});

  // props (furniture) — purely visual but helps feel 3D
  function prop(id,floor,x,y,label,tint=0){
    addObj({id, floor, x,y, kind:"prop", name:label, tint, solid:false});
  }
  prop("couch",0,14.2,10.2,"Couch",0.18);
  prop("table",0,13.0,8.5,"Coffee Table",0.10);
  prop("lamp",0,16.5,8.2,"Lamp",0.24);
  prop("kitchenIsland",0,10.8,3.6,"Kitchen Island",0.08);
  prop("stairsRail",0,9.5,8.7,"Stairs",0.05);

  prop("bed",1,15.4,4.7,"Bed",0.15);
  prop("dresser",1,13.2,6.0,"Dresser",0.12);
  prop("hallPlant",1,11.5,8.5,"Plant",0.20);

  // window “zones” (for outside silhouette event)
  addObj({id:"windowDown", floor:0, x:2.5,y:2.5, kind:"window", name:"Living Room Window"});
  addObj({id:"windowUp",   floor:1, x:18.0,y:2.5, kind:"window", name:"Upstairs Hall Window"});

  const inventory=new Set();
  const tasksLeft=()=>objs.filter(o=>o.kind==="task" && !o.done).length;

  // ----------------- Player / POV -----------------
  const player={x:11.0,y:11.2,a:-Math.PI/2,fov:Math.PI/3,moveSpeed:2.6,bob:0,bobPhase:0};
  let pointerLocked=false;
  canvas.addEventListener("click", ()=>{ if(state.finished) return; initAudio(); canvas.requestPointerLock?.(); });
  document.addEventListener("pointerlockchange", ()=>{
    pointerLocked=(document.pointerLockElement===canvas);
    metaEl.textContent=pointerLocked?"Mouse captured • Esc releases":"Click the game to capture the mouse";
  });
  document.addEventListener("mousemove",(e)=>{
    if(pointerLocked && state.started && !state.finished) player.a += e.movementX*0.0022;
  });

  const keys=new Set();
  window.addEventListener("keydown",(e)=>{
    const k=e.key.toLowerCase();
    keys.add(k);
    if(k==="e") interact();
    if(k==="f") toggleFlash();
  });
  window.addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()));

  // ----------------- Flashlight -----------------
  const flash={on:true,battery:1.0,drainPerMin:0.012,cone:0.44,range:8.4};
  function toggleFlash(){
    if(!state.started||state.finished) return;
    flash.on=!flash.on; sfx.toggle();
    flashHud.textContent=flash.on?"ON":"OFF";
  }

  // ----------------- Raycast rendering (2.5D) -----------------
  const RAYS=420;
  function castRay(ax){
    const sin=Math.sin(ax), cos=Math.cos(ax);
    let dist=0; const step=0.02;
    for(let i=0;i<5200;i++){
      dist+=step;
      const x=player.x+cos*dist, y=player.y+sin*dist;
      const mx=Math.floor(x), my=Math.floor(y);
      if(mx<0||my<0||mx>=MAP_W||my>=MAP_H) break;
      if(map()[my][mx]===1){
        const tex=(Math.sin((x+y)*2.15)+1)*0.5;
        return {hit:true,dist,tex};
      }
    }
    return {hit:false,dist:999,tex:0};
  }
  function flashlightAmount(rayA, dist){
    if(!flash.on || flash.battery<=0.02) return 0.18;
    const diff=Math.atan2(Math.sin(rayA-player.a),Math.cos(rayA-player.a));
    const inCone=Math.abs(diff)<=flash.cone;
    if(!inCone) return 0.22;
    const rangeFactor=clamp(1 - dist/flash.range, 0, 1);
    const centerFactor=clamp(1 - (Math.abs(diff)/flash.cone), 0, 1);
    return 0.22 + 0.95*(rangeFactor*centerFactor);
  }

  function draw(){
    const w=canvas.width, h=canvas.height;
    const hShift = player.bob*14;

    // ceiling/floor
    const topG=ctx.createLinearGradient(0,0,0,h/2+hShift);
    topG.addColorStop(0,"#05070b"); topG.addColorStop(1,state.floor? "#070914":"#070b12");
    ctx.fillStyle=topG; ctx.fillRect(0,0,w,h/2+hShift);

    const botG=ctx.createLinearGradient(0,h/2+hShift,0,h);
    botG.addColorStop(0,state.floor? "#050714":"#050814"); botG.addColorStop(1,"#03040a");
    ctx.fillStyle=botG; ctx.fillRect(0,h/2+hShift,w,h/2-hShift);

    // floor lines
    for(let y=h/2+hShift;y<h;y+=5){
      const a=clamp((y-(h/2+hShift))/(h/2),0,1);
      ctx.fillStyle=`rgba(255,255,255,${0.02*(1-a)})`;
      ctx.fillRect(0,y,w,1);
    }

    // rays
    const depth=new Array(RAYS).fill(999);
    for(let i=0;i<RAYS;i++){
      const rayA = player.a - player.fov/2 + (i/(RAYS-1))*player.fov;
      const r=castRay(rayA);
      if(!r.hit) continue;
      const corrected = r.dist * Math.cos(rayA-player.a);
      depth[i]=corrected;

      const wallH = clamp((h*0.98)/(corrected+0.0001), 0, h*1.35);
      const x=(i/RAYS)*w, colW=(w/RAYS)+1;

      const shade=clamp(1 - corrected/9.5, 0.06, 1);
      const tex=0.86+0.18*r.tex;

      let base=18+Math.floor(138*shade*tex);
      let rr=base, gg=base+10, bb=base+28;

      // upstairs slightly colder
      if(state.floor===1){ bb+=14; rr-=4; gg-=2; }

      const light=flashlightAmount(rayA, corrected);
      rr=Math.floor(rr*(0.48+0.52*light));
      gg=Math.floor(gg*(0.48+0.52*light));
      bb=Math.floor(bb*(0.48+0.52*light));

      ctx.fillStyle=`rgb(${rr},${gg},${bb})`;
      ctx.fillRect(x,(h-wallH)/2+hShift,colW,wallH);
    }

    drawObjs(depth,hShift);
    drawOverlay(hShift);
    drawCrosshair(hShift);
    drawInteractHint(hShift);
  }

  function drawOverlay(hShift){
    const w=canvas.width, h=canvas.height;

    const vg=ctx.createRadialGradient(w/2,h/2+hShift,h*0.15, w/2,h/2+hShift,h*0.78);
    vg.addColorStop(0,"rgba(0,0,0,0)");
    vg.addColorStop(1, flash.on ? "rgba(0,0,0,0.58)" : "rgba(0,0,0,0.80)");
    ctx.fillStyle=vg; ctx.fillRect(0,0,w,h);

    if(flash.on && flash.battery>0.02){
      ctx.save();
      ctx.translate(w/2,h/2+hShift);
      ctx.globalCompositeOperation="lighter";
      const g=ctx.createRadialGradient(0,0,10, 0,0, Math.min(w,h)*0.58);
      const strength=0.14+0.20*flash.battery;
      g.addColorStop(0,`rgba(120,170,255,${strength})`);
      g.addColorStop(1,"rgba(120,170,255,0)");
      ctx.fillStyle=g;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,Math.min(w,h)*0.65,-flash.cone,flash.cone);
      ctx.closePath(); ctx.fill();
      ctx.restore();
      ctx.globalCompositeOperation="source-over";
    }

    // subtle “outside silhouette” overlay moment
    if(state.beatFlags.silhouette){
      ctx.fillStyle="rgba(0,0,0,.25)";
      ctx.fillRect(0,0,w,h);
    }
  }

  function drawCrosshair(hShift){
    const w=canvas.width, h=canvas.height;
    ctx.strokeStyle="rgba(255,255,255,.55)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(w/2-8,h/2+hShift); ctx.lineTo(w/2+8,h/2+hShift);
    ctx.moveTo(w/2,h/2-8+hShift); ctx.lineTo(w/2,h/2+8+hShift);
    ctx.stroke();
  }

  function drawInteractHint(hShift){
    const w=canvas.width, h=canvas.height;
    const t=getTarget();
    if(!t) return;
    ctx.fillStyle="rgba(0,0,0,.45)";
    ctx.fillRect(12,h-44,w-24,32);
    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.font="14px system-ui";
    ctx.fillText(`Press E: ${prompt(t)}`, 22, h-22);
  }

  function drawObjs(depth,hShift){
    const w=canvas.width, h=canvas.height;

    // collect visible objects on current floor
    const vis=[];
    for(const o of objs){
      if(o.floor !== undefined && o.floor !== state.floor) continue;
      if(o.kind==="item" && o.picked) continue;
      if(o.kind==="task" && o.done) {
        // still show faintly sometimes: keep it hidden for clarity
      }

      const dx=o.x-player.x, dy=o.y-player.y;
      const dRaw=Math.hypot(dx,dy);
      if(dRaw>9.0) continue;

      const ang=Math.atan2(dy,dx);
      const rel=Math.atan2(Math.sin(ang-player.a),Math.cos(ang-player.a));
      if(Math.abs(rel)>player.fov/2+0.25) continue;

      const idx=Math.floor(((rel+player.fov/2)/player.fov)*(RAYS-1));
      const corrected=dRaw*Math.cos(rel);
      if(idx>=0 && idx<RAYS && depth[idx] < corrected-0.06) continue;

      vis.push({o,rel,dist:corrected});
    }
    vis.sort((a,b)=>b.dist-a.dist);

    for(const v of vis){
      const {o,rel,dist}=v;
      const size=clamp((h*0.70)/(dist+0.0001),12,h*0.70);
      const xCenter=(0.5+(rel/player.fov))*w;
      const x=xCenter-size*0.20;
      const y=(h-size)/2+hShift;

      let widthMul=0.40, heightMul=1.0;
      let color="rgba(180,180,220,.82)";
      if(o.kind==="prop"){ color=`rgba(${120},${120+Math.floor(30*o.tint)},${160+Math.floor(50*o.tint)},.80)`; widthMul=0.52; heightMul=0.55; }
      if(o.kind==="task"){ color=o.done?"rgba(52,211,153,.40)":"rgba(180,180,220,.82)"; widthMul=0.34; heightMul=0.75; }
      if(o.kind==="item"){ color="rgba(96,165,250,.86)"; widthMul=0.26; heightMul=0.50; }
      if(o.kind==="door"){ color=o.locked?"rgba(52,211,153,.86)":"rgba(251,113,133,.86)"; widthMul=0.34; heightMul=1.05; }
      if(o.kind==="stairs"){ color="rgba(245,158,11,.70)"; widthMul=0.34; heightMul=0.70; }
      if(o.kind==="window"){ color="rgba(147,197,253,.45)"; widthMul=0.38; heightMul=0.80; }

      // door open “thin”
      if(o.kind==="door"){
        const open=o.open;
        widthMul=clamp(0.34*(1-open)+0.10*open,0.10,0.34);
      }

      const light=flashlightAmount(player.a+rel,dist);
      const a=0.50+0.44*(0.5+0.5*light);

      // shadow
      ctx.fillStyle="rgba(0,0,0,.25)";
      ctx.fillRect(x+3,y+3,size*widthMul,size*heightMul);

      // sprite block
      ctx.fillStyle=color.replace(".86",String(a)).replace(".82",String(a)).replace(".80",String(a)).replace(".70",String(a)).replace(".45",String(a));
      ctx.fillRect(x,y,size*widthMul,size*heightMul);

      // silhouette “outside window” moment: draw a tall figure when flagged
      if(o.kind==="window" && state.beatFlags.silhouette){
        const silW=size*0.18, silH=size*0.65;
        ctx.fillStyle="rgba(0,0,0,.75)";
        ctx.fillRect(x+size*0.10, y+size*0.08, silW, silH);
      }
    }
  }

  // ----------------- Interaction -----------------
  function getTarget(){
    let best=null;
    for(const o of objs){
      if(o.floor !== undefined && o.floor !== state.floor) continue;
      if(o.kind==="item" && o.picked) continue;

      const dx=o.x-player.x, dy=o.y-player.y;
      const dist=Math.hypot(dx,dy);
      if(dist>2.3) continue;

      const ang=Math.atan2(dy,dx);
      const diff=Math.atan2(Math.sin(ang-player.a),Math.cos(ang-player.a));
      if(Math.abs(diff)>0.21) continue;

      const r=castRay(ang);
      if(r.hit && r.dist < dist-0.06) continue;

      if(!best || dist<best.dist) best={o,dist};
    }
    return best?best.o:null;
  }

  function prompt(o){
    if(o.kind==="door"){
      if(o.opening) return `${o.name} (moving...)`;
      if(o.open>0.65) return `${o.name} (close)`;
      return o.locked ? `${o.name} (unlock/lock check)` : `${o.name} (open / lock)`;
    }
    if(o.kind==="task") return o.done ? `${o.name} (done)` : `${o.name} (do it)`;
    if(o.kind==="item") return `Pick up: ${o.name}`;
    if(o.kind==="stairs") return o.floorTo===1 ? "Go upstairs" : "Go downstairs";
    if(o.kind==="window") return `Look out: ${o.name}`;
    return o.name;
  }

  function interact(){
    if(!state.started || state.finished) return;
    const t=getTarget(); if(!t) return;

    if(t.kind==="item"){
      t.picked=true; inventory.add(t.id); sfx.pickup();
      if(t.id==="batteries") flash.battery=clamp(flash.battery+0.55,0,1);
      setDialogue("You",`Picked up: ${t.name}.`,[]);
      return;
    }

    if(t.kind==="task"){
      if(t.done){ setDialogue("Narrator","Already done.",[]); return; }
      t.done=true;
      sfx.text();
      setDialogue("You",`${t.name}… done.`,[]);
      updateHUD(); checkWin();
      return;
    }

    if(t.kind==="door"){
      if(!t.locked && t.open<0.1){
        t.locked=true; sfx.door();
        setDialogue("Narrator",`${t.name} locked.`,[]);
        updateHUD(); checkWin();
        return;
      }
      t.opening=true; sfx.door();
      const goingOpen=(t.open<0.5);
      t._targetOpen=goingOpen?1:0;
      setDialogue("Narrator",goingOpen?"Door opens…":"Door closes…",[]);
      // opening doors after knock increases dread
      if(state.beatFlags.knock && t.id==="frontDoor" && goingOpen){
        state.dread+=22; sfx.sting();
        setDialogue("Narrator","Nope. That was a bad choice.",[]);
      }
      updateHUD(); checkWin();
      return;
    }

    if(t.kind==="stairs"){
      if(state.floor !== t.floorFrom) return;
      state.floor = t.floorTo;
      floorHud.textContent = (state.floor+1);
      sfx.step();
      setDialogue("Narrator", state.floor===1
        ? "Upstairs feels colder. The air is… different."
        : "Back downstairs. The house hums like nothing happened.", []);
      updateHUD();
      return;
    }

    if(t.kind==="window"){
      // looking out can trigger silhouette beat
      if(!state.beatFlags.silhouette && state.minute>=8){
        state.beatFlags.silhouette=true;
        state.dread+=18;
        sfx.sting();
        setDialogue("Narrator","For half a second… a shape stands outside. Then it’s gone.",[
          {label:"Back away", kind:"primary", onClick:()=>setDialogue("You","Okay. No more windows.",[])},
          {label:"Text friend", onClick:()=>{
            addMsg("me","I saw something outside the window.");
            addMsg("Friend","Lock everything. Don’t investigate.");
            setDialogue("Narrator","You feel your hands shaking.",[]);
          }}
        ]);
        setTimeout(()=>{ state.beatFlags.silhouette=false; }, 2500);
      } else {
        setDialogue("Narrator","Dark yard. Nothing obvious. Still… you don’t like it.",[]);
        state.dread+=2;
      }
      updateHUD();
      return;
    }
  }

  // ----------------- Movement -----------------
  function move(dt){
    let f=0,s=0;
    if(keys.has("w")) f+=1;
    if(keys.has("s")) f-=1;
    if(keys.has("a")) s-=1;
    if(keys.has("d")) s+=1;

    const moving=Math.abs(f)+Math.abs(s)>0.1;
    const spMult = keys.has("shift") ? 1.25 : 1.0;
    const speed=player.moveSpeed*dt*spMult;
    const cos=Math.cos(player.a), sin=Math.sin(player.a);

    let nx=player.x+(cos*f - sin*s)*speed;
    let ny=player.y+(sin*f + cos*s)*speed;

    const pad=0.18;
    if(!isWall(nx,player.y) && !isWall(nx+Math.sign(nx-player.x)*pad,player.y)) player.x=nx;
    if(!isWall(player.x,ny) && !isWall(player.x,ny+Math.sign(ny-player.y)*pad,player.y)) player.y=ny;

    if(moving){
      player.bobPhase += dt*9.5;
      player.bob = Math.sin(player.bobPhase)*0.35;
      if(now()-state.lastStepSfx>260){ sfx.step(); state.lastStepSfx=now(); }
    } else {
      player.bob*=0.90; if(Math.abs(player.bob)<0.01) player.bob=0;
    }
  }

  function updateDoors(dt){
    for(const o of objs){
      if(o.kind!=="door" || o.floor!==state.floor || !o.opening) continue;
      const target=o._targetOpen ?? 0;
      o.open += (target-o.open)*clamp(1.6*dt,0,1);
      if(Math.abs(o.open-target)<0.02){ o.open=target; o.opening=false; }
    }
  }

  // ----------------- HUD / win logic -----------------
  function updateHUD(){
    clockEl.textContent=timeStr();
    tasksEl.textContent=tasksLeft();
    floorHud.textContent=(state.floor+1);

    let vibe="Calm", warn=false;
    if(state.dread>=75){ vibe="PANIC"; warn=true; }
    else if(state.dread>=45){ vibe="On Edge"; warn=true; }
    else if(state.dread>=25){ vibe="Uneasy"; }
    vibeEl.textContent=vibe;
    warn ? vibePill.classList.add("warn") : vibePill.classList.remove("warn");
  }

  function checkWin(){
    const front=objs.find(o=>o.id==="frontDoor");
    const back=objs.find(o=>o.id==="backDoor");
    const allTasksDone = tasksLeft()===0;
    const doorsLocked = front.locked && back.locked;
    if(allTasksDone && doorsLocked && !state.finished){
      end("SAFE","Tasks done. Doors locked. The house finally feels… normal again.");
    }
  }

  function end(title,text){
    state.finished=true;
    ramp(ambGain,0.0,0.5);
    document.exitPointerLock?.();
    setDialogue("Ending: "+title, text, [
      {label:"Restart",kind:"primary",onClick:reset},
      {label:"Release mouse",onClick:()=>document.exitPointerLock?.()}
    ]);
  }

  // ----------------- Story beats (texts + knocks + upstairs noises) -----------------
  function beatsTick(mins){
    for(let i=0;i<mins;i++){
      state.minute++;
      flash.battery=clamp(flash.battery - flash.drainPerMin, 0, 1);
      if(flash.battery<=0.02){ flash.on=false; flashHud.textContent="OFF"; }

      const m=state.minute;

      if(m===1){
        addMsg("Carson’s Mom","Thanks again. Quick list: lights, TV, trash, and check the upstairs window. Lock both doors.");
        addMsg("Friend","This is chill. Get in, do the list, leave. Easy money.");
      }

      if(m===4 && !state.beatFlags.unknown){
        state.beatFlags.unknown=true;
        state.dread+=14; sfx.sting();
        addMsg("Unknown","you’re inside.");
        setDialogue("Narrator","Your phone buzzes. Unknown number. Two words: “you’re inside.”",[
          {label:"Text Mom",kind:"primary",onClick:()=>{
            addMsg("me","Someone texted: you’re inside.");
            addMsg("Carson’s Mom","LOCK THE DOORS. Call me right now.");
            state.dread=Math.max(0,state.dread-6);
            setDialogue("Carson’s Mom","Do not open the door. Do not go outside.",[]);
          }},
          {label:"Ignore it",onClick:()=>setDialogue("You","It’s probably a prank. Probably.",[])}
        ]);
      }

      if(m===7 && !state.beatFlags.upstairsNoise){
        state.beatFlags.upstairsNoise=true;
        state.dread+=12; sfx.thump();
        setDialogue("Narrator","A soft THUMP from upstairs. Like a footstep… or a book falling.",[
          {label:"Go upstairs",kind:"primary",onClick:()=>setDialogue("You","Okay. I’m checking upstairs.",[])},
          {label:"Finish downstairs first",onClick:()=>setDialogue("You","Nope. List first. Then upstairs.",[])}
        ]);
      }

      if(m===10 && !state.beatFlags.knock){
        state.beatFlags.knock=true;
        state.dread+=18; sfx.rattle(); sfx.sting();
        setDialogue("Narrator","KNOCK… KNOCK… KNOCK… from the front door.",[
          {label:"Stay quiet",kind:"primary",onClick:()=>setDialogue("You","Not moving.",[])},
          {label:"Text friend",onClick:()=>{
            addMsg("me","Someone is knocking.");
            addMsg("Friend","Don’t open it. Lock up. Call Carson’s mom.");
            setDialogue("Narrator","Your chest tightens.",[]);
          }}
        ]);
      }

      // if they’re upstairs after a while, add dread slowly
      if(m>=12 && state.floor===1){
        state.dread += 1;
      }

      // if time runs out and they didn't finish
      if(m>=24 && !state.finished){
        if(tasksLeft()>0){
          end("SURVIVED","Time passes. Nothing breaks in… but you’ll never forget that text: “you’re inside.”");
        } else {
          checkWin();
        }
      }

      state.dread=clamp(state.dread,0,100);
    }
    updateHUD();
  }

  // ----------------- Phone send -----------------
  function handleSend(){
    const t=input.value.trim(); if(!t) return;
    initAudio();
    addMsg("me", t);
    input.value="";
    const lower=t.toLowerCase();
    if(lower==="help"){ addMsg("Carson’s Mom","Type: ok / calling / someone is here"); return; }
    if(lower==="ok"){ addMsg("Carson’s Mom","Good. Keep the doors locked. Text me when the list is done."); state.dread=Math.max(0,state.dread-2); updateHUD(); return; }
    if(lower.includes("calling")){ addMsg("Carson’s Mom","Call me now. Speakerphone. Stay inside."); return; }
    if(lower.includes("someone")){ addMsg("Carson’s Mom","Do NOT open. I’m contacting a neighbor."); state.dread=Math.max(0,state.dread-4); updateHUD(); return; }
    addMsg("Carson’s Mom","Okay. Keep me updated.");
  }
  sendBtn.addEventListener("click", handleSend);
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") handleSend(); });

  // ----------------- Start/reset/game loop -----------------
  let last=performance.now(), acc=0;
  function update(dt){
    if(!state.started || state.finished) return;

    move(dt);
    updateDoors(dt);

    acc += dt;
    if(acc>=2.8){
      const mins=Math.floor(acc/2.8);
      acc -= mins*2.8;
      beatsTick(mins);
    }

    if(audioCtx){
      const target = 0.22 + (state.dread/100)*0.14;
      ramp(ambGain, clamp(target,0,0.55), 0.25);
      // slightly lower ambience upstairs
      if(state.floor===1) {
        noiseFilter.frequency.value = 820;
        humOsc.frequency.value = 48;
      } else {
        noiseFilter.frequency.value = 950;
        humOsc.frequency.value = 52;
      }
    }
  }

  function loop(t){
    const dt=Math.min(0.033,(t-last)/1000);
    last=t;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  function start(){
    state.started=true;
    initAudio();
    ramp(ambGain,0.24,0.7);
    setDialogue("Narrator",
      "Checklist: turn off kitchen light, TV off, take out trash, check upstairs hallway window. Lock both doors.",
      [
        {label:"Start",kind:"primary",onClick:()=>setDialogue("Narrator","Go. Keep your phone loud.",[])},
        {label:"Controls",onClick:()=>setDialogue("Controls","WASD move, mouse look (click game), E interact, F flashlight, Shift sprint, Esc release mouse.",[
          {label:"Back",kind:"primary",onClick:()=>setDialogue("Narrator","Go. Keep your phone loud.",[])}
        ])}
      ]
    );
  }

  function reset(){
    state.started=false; state.finished=false;
    state.minute=0; state.dread=0; state.floor=0;
    state.beatFlags={unknown:false, window:false, upstairsNoise:false, knock:false, silhouette:false};
    acc=0;
    player.x=11.0; player.y=11.2; player.a=-Math.PI/2; player.bob=0; player.bobPhase=0;
    flash.on=true; flash.battery=1.0; flashHud.textContent="ON";
    inventory.clear();

    for(const o of objs){
      if(o.kind==="door"){ o.locked=false; o.open=0; o.opening=false; o._targetOpen=0; }
      if(o.kind==="task"){ o.done=false; }
      if(o.kind==="item"){ o.picked=false; }
    }

    msgsEl.innerHTML="";
    addMsg("Carson’s Mom","Thanks again. Quick list: lights, TV, trash, upstairs window. Lock both doors.");
    addMsg("Friend","This is chill. Get in, do the list, leave. Easy money.");

    setDialogue("Narrator","Click the game to capture the mouse. Then press Start.",[
      {label:"Start",kind:"primary",onClick:start}
    ]);
    updateHUD();
  }

  // boot
  reset();
  requestAnimationFrame(loop);

  // start ambience only after first click (browser rules)
})();
</script>
</body>
</html>
